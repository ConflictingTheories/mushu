<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>mushu â€” WebGPU Smoke Demo</title>
  <link rel="stylesheet" href="../common.css">
  <style>
    .info code { color: #aabbcc; }
  </style>
</head>
<body>
<div class="info">ğŸ’¨ <code>mushu().gpu(compute, render)</code> Match Smoke | Move mouse - smoke trails from cursor</div>
<canvas id="c" style="position:fixed;inset:0;width:100%;height:100%"></canvas>
<script type="module">
import { mushu } from '../../src/index.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WebGPU Match Smoke - Smoke emits from mouse cursor like a match
// 
// Features:
//   â€¢ Smoke emits from mouse position
//   â€¢ Realistic rising and billowing
//   â€¢ Turbulent swirls and wisps
//   â€¢ Proper volumetric lighting
//   â€¢ Smoke trail follows mouse movement
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mushu('#c').gpu(
  null,
  /* wgsl */`
    fn hash(p: vec2<f32>) -> f32 {
      var p3 = fract(vec3<f32>(p.xyx) * 0.1031);
      p3 = p3 + dot(p3, p3.yzx + 33.33);
      return fract((p3.x + p3.y) * p3.z);
    }
    
    fn noise(p: vec2<f32>) -> f32 {
      let i = floor(p);
      let f = fract(p);
      let u = f * f * (3.0 - 2.0 * f);
      return mix(
        mix(hash(i), hash(i + vec2<f32>(1.0, 0.0)), u.x),
        mix(hash(i + vec2<f32>(0.0, 1.0)), hash(i + vec2<f32>(1.0, 1.0)), u.x),
        u.y
      );
    }
    
    fn fbm(p: vec2<f32>, octaves: i32) -> f32 {
      var value = 0.0;
      var amplitude = 0.5;
      var pos = p;
      let rot = mat2x2<f32>(0.8, 0.6, -0.6, 0.8);
      for (var i = 0; i < 6; i++) {
        if (i >= octaves) { break; }
        value += amplitude * noise(pos);
        pos = rot * pos * 2.0;
        amplitude *= 0.5;
      }
      return value;
    }

    fn render(data: vec4<f32>, uv: vec2<f32>) -> vec4<f32> {
      let aspect = u.resolution.x / u.resolution.y;
      let t = u.time;
      
      // Mouse position is smoke source
      var smokeSource = u.mouse;
      smokeSource.y = 1.0 - smokeSource.y; // Flip Y
      
      // Position relative to smoke source
      var p = uv - smokeSource;
      p.x *= aspect;
      
      // Smoke rises UP from source
      p.y = -p.y;
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Smoke Plume Shape
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      var smoke = 0.0;
      
      // Multiple smoke layers for depth
      for (var layer = 0; layer < 4; layer++) {
        let fl = f32(layer);
        let layerOffset = fl * 0.15;
        let layerPhase = fl * 2.3;
        
        // Smoke column with turbulent sway
        var smokeP = p;
        
        // Sway increases with height
        let swayAmount = smokeP.y * 0.4;
        let sway = fbm(vec2<f32>(smokeP.y * 2.0 + layerPhase, t * 0.3 + fl), 3) - 0.5;
        smokeP.x += sway * swayAmount;
        
        // Additional turbulent distortion
        let turbX = fbm(vec2<f32>(smokeP.y * 4.0, t * 0.5 + layerPhase), 4) - 0.5;
        let turbY = fbm(vec2<f32>(smokeP.x * 4.0 + 100.0, t * 0.4 + layerPhase), 4) - 0.5;
        smokeP += vec2<f32>(turbX, turbY) * 0.08 * smokeP.y;
        
        // Smoke expands as it rises
        let expansion = 1.0 + smokeP.y * 2.0;
        let width = 0.03 * expansion;
        
        // Column density
        let xDist = abs(smokeP.x) / width;
        var column = exp(-xDist * xDist * 2.0);
        
        // Fade with height
        let heightFade = exp(-smokeP.y * 1.5);
        column *= heightFade;
        
        // Only visible above source
        column *= smoothstep(-0.02, 0.05, smokeP.y);
        
        // Billowing effect
        let billow = fbm(smokeP * 10.0 + vec2<f32>(layerPhase, -t * 1.5), 5);
        column *= 0.5 + billow * 0.7;
        
        smoke += column * (0.4 - fl * 0.08);
      }
      
      // Add wispy tendrils breaking off
      let tendrilP = p + vec2<f32>(
        fbm(vec2<f32>(p.y * 8.0, t), 3) - 0.5,
        0.0
      ) * 0.15;
      let tendrils = fbm(tendrilP * 15.0 + vec2<f32>(0.0, -t * 2.0), 4);
      let tendrilMask = exp(-abs(p.x) * 8.0) * exp(-p.y * 0.5) * step(0.0, p.y);
      smoke += tendrils * tendrilMask * 0.3;
      
      // Near-source intensity
      let sourceDist = length(p);
      let sourceIntensity = exp(-sourceDist * 20.0) * 0.5;
      smoke += sourceIntensity;
      
      smoke = clamp(smoke, 0.0, 1.0);
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Volumetric Lighting (Beer-Lambert)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      let absorption = 2.5;
      let transmittance = exp(-smoke * absorption);
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Smoke Colors with Lighting
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      // Base smoke color - slight warm tint near source, cool as it rises
      let warmSmoke = vec3<f32>(0.75, 0.72, 0.68);
      let coolSmoke = vec3<f32>(0.6, 0.62, 0.68);
      var smokeColor = mix(warmSmoke, coolSmoke, clamp(p.y * 2.0, 0.0, 1.0));
      
      // Darker in dense areas
      let denseColor = vec3<f32>(0.25, 0.26, 0.28);
      smokeColor = mix(smokeColor, denseColor, smoke * 0.5);
      
      // Top-lit (light from above)
      let topLight = 0.6 + (1.0 - uv.y) * 0.4;
      smokeColor *= topLight;
      
      // Subtle rim lighting
      let rim = pow(smoke, 0.7) * 0.2;
      smokeColor += vec3<f32>(0.3, 0.32, 0.38) * rim;
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Ember Glow at Source
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      let emberGlow = exp(-sourceDist * 30.0);
      let emberFlicker = 0.7 + 0.3 * sin(t * 12.0) * sin(t * 19.0);
      var ember = vec3<f32>(1.0, 0.4, 0.1) * emberGlow * emberFlicker * 0.6;
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Background
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      let bgTop = vec3<f32>(0.03, 0.04, 0.06);
      let bgBottom = vec3<f32>(0.02, 0.02, 0.03);
      var bg = mix(bgBottom, bgTop, uv.y);
      
      // Ambient glow from ember
      let ambientGlow = exp(-length(uv - vec2<f32>(smokeSource.x, 1.0 - smokeSource.y)) * 4.0);
      bg += vec3<f32>(0.1, 0.04, 0.02) * ambientGlow * 0.3;
      
      // Vignette
      let vignette = 1.0 - length(uv - 0.5) * 0.4;
      bg *= vignette;
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Final Compositing
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      var col = mix(smokeColor, bg, transmittance);
      col += ember;
      
      // Atmospheric haze
      col = mix(col, vec3<f32>(0.4, 0.42, 0.48), (1.0 - transmittance) * 0.05);
      
      // Film grain
      let grain = (hash(uv * 500.0 + t * 100.0) - 0.5) * 0.02;
      col += grain;
      
      // Tone mapping
      col = col / (col + 0.6);
      col = pow(col, vec3<f32>(0.95));
      
      return vec4<f32>(col, 1.0);
    }
  `,
  { canvas: document.getElementById('c') }
);

// FPS Counter
(function() {
  const fpsDiv = document.createElement('div');
  fpsDiv.style.cssText = 'position:fixed;bottom:10px;left:10px;color:white;font:14px monospace;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:4px;z-index:10000';
  document.body.appendChild(fpsDiv);
  let frames = 0, lastTime = performance.now();
  function updateFPS() {
    frames++;
    const now = performance.now();
    if (now - lastTime >= 500) {
      fpsDiv.textContent = Math.round(frames * 1000 / (now - lastTime)) + ' fps';
      frames = 0; lastTime = now;
    }
    requestAnimationFrame(updateFPS);
  }
  updateFPS();
})();

console.log('%c ğŸ’¨ WebGPU Match Smoke ', 'background: linear-gradient(90deg, #445, #778); color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold;');
console.log('Move mouse - smoke trails from cursor like a match!');
</script>
<script>
// Hide home-link if in iframe - run immediately and on load
function hideIfIframe() {
  if (window.self !== window.top) {
    const link = document.querySelector('.home-link');
    if (link) {
      link.style.display = 'none';
    }
  }
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', hideIfIframe);
} else {
  hideIfIframe();
}
</script>
<a href="index.html" class="home-link">â† Back to Index</a>
</body>
</html>
