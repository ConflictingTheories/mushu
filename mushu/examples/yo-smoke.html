<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>mushu â€” YO Smoke Demo</title>
  <style>body{margin:0;overflow:hidden;background:#000}</style>
</head>
<body>
<canvas id="c" style="position:fixed;inset:0;width:100%;height:100%"></canvas>
<script type="module">
import { glsl } from '../src/core/yo.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YO Smoke - Procedural Approach (same as the working GLSL demo)
// 
// Uses purely procedural noise for beautiful volumetric smoke
// No broken simulation - just gorgeous smoke every frame!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

glsl(`
  float hash(vec2 p) {
    vec3 p3 = fract(vec3(p.xyx) * 0.1031);
    p3 += dot(p3, p3.yzx + 33.33);
    return fract((p3.x + p3.y) * p3.z);
  }
  
  float noise(vec2 p) {
    vec2 i = floor(p);
    vec2 f = fract(p);
    f = f * f * f * (f * (f * 6.0 - 15.0) + 10.0);
    return mix(
      mix(hash(i), hash(i + vec2(1,0)), f.x),
      mix(hash(i + vec2(0,1)), hash(i + vec2(1,1)), f.x),
      f.y
    );
  }
  
  float fbm(vec2 p, int octaves) {
    float f = 0.0;
    float amp = 0.5;
    mat2 rot = mat2(0.8, 0.6, -0.6, 0.8);
    for (int i = 0; i < 8; i++) {
      if (i >= octaves) break;
      f += amp * noise(p);
      p = rot * p * 2.0;
      amp *= 0.5;
    }
    return f;
  }
  
  void mainImage(out vec4 O, vec2 C) {
    vec2 uv = C / resolution;
    vec2 p = (C - resolution * 0.5) / resolution.y;
    float t = time * 0.4;
    
    // Base smoke columns
    float smoke = 0.0;
    
    // Multiple smoke streams
    for (int i = 0; i < 5; i++) {
      float fi = float(i);
      float xOffset = sin(fi * 1.3) * 0.3;
      vec2 smokePos = vec2(p.x - xOffset, p.y + 0.4);
      
      // Rising motion with turbulence
      float rise = fbm(vec2(smokePos.x * 2.0, t + fi), 4);
      smokePos.y += rise * 0.3;
      smokePos.x += sin(smokePos.y * 3.0 + t + fi) * 0.08;
      
      // Turbulent distortion
      float turb = fbm(smokePos * 4.0 + t * 0.5 + fi, 5);
      smokePos += (turb - 0.5) * 0.15;
      
      // Smoke density falloff
      float dist = length(smokePos * vec2(3.0, 1.0));
      float column = exp(-dist * 2.5);
      
      // Add wispy tendrils
      float tendrils = fbm(smokePos * 8.0 - vec2(0, t), 3);
      column *= (0.5 + tendrils * 0.8);
      
      smoke += column * (0.3 + 0.2 * sin(fi));
    }
    
    // Add swirling vortices
    float swirl = fbm(p * 3.0 + t * 0.3, 4);
    smoke += swirl * 0.2 * (1.0 - uv.y);
    
    // Mouse interaction - disperse smoke
    vec2 mouseP = mouse - 0.5;
    mouseP.x *= resolution.x / resolution.y;
    float mouseDist = length(p - mouseP);
    float mouseInfluence = exp(-mouseDist * 6.0);
    smoke += mouseInfluence * 0.5;
    smoke *= 1.0 - mouseInfluence * 0.4; // Dispersal effect
    
    // Volumetric lighting
    vec3 smokeColorLight = vec3(0.65, 0.68, 0.72);
    vec3 smokeColorDark = vec3(0.15, 0.15, 0.18);
    
    // Light from above
    float topLight = uv.y * 0.3;
    vec3 smokeColor = mix(smokeColorDark, smokeColorLight, topLight + smoke * 0.3);
    
    // Rim lighting
    float rim = pow(smoke, 0.5) * 0.3;
    smokeColor += vec3(0.2, 0.22, 0.25) * rim;
    
    // Beer-Lambert absorption
    float density = clamp(smoke, 0.0, 1.0);
    float transmittance = exp(-density * 2.0);
    
    // Background gradient
    vec3 bgColor = mix(vec3(0.02, 0.02, 0.04), vec3(0.08, 0.08, 0.12), uv.y);
    
    // Composite smoke over background
    vec3 color = mix(smokeColor, bgColor, transmittance);
    
    // Add subtle glow at source
    float sourceGlow = exp(-length(p + vec2(0, 0.5)) * 3.0) * 0.5;
    color += vec3(1.0, 0.6, 0.3) * sourceGlow * (1.0 - transmittance);
    
    // Film grain
    float grain = (hash(C + time) - 0.5) * 0.03;
    color += grain;
    
    // Vignette
    float vignette = 1.0 - length(uv - 0.5) * 0.4;
    color *= vignette;
    
    O = vec4(color, 1.0);
  }
`, document.getElementById('c'));

console.log('%c ğŸ’¨ YO Smoke ', 'background: linear-gradient(90deg, #556, #889); color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold;');
console.log('Procedural smoke using glsl() helper');
</script>
</body>
</html>
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Density Diffusion
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    float avgDensity = (up.r + down.r + left.r + right.r) * 0.25;
    density = mix(density, avgDensity, 0.08);
    
    // Dissipation - smoke fades over time
    density *= 0.997;
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Mouse Smoke Emission
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    float d = length(uv - mouse);
    if (mouseDown > 0.5 && d < 0.1) {
      float falloff = pow(1.0 - d / 0.1, 2.0);
      density += falloff * 0.6;
      temp += falloff * 0.8;
      
      // Add velocity based on mouse movement (mouseVelocity is already provided)
      vel += mouseVelocity * falloff * 3.0;
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Auto-emitters at Bottom
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    if (uv.y < 0.08) {
      float edge = 1.0 - uv.y / 0.08;
      edge = edge * edge;
      
      // Multiple emitter sources with varying behavior
      float emitter1 = fbm(vec2(uv.x * 10.0, time * 1.5), 3);
      float emitter2 = noise(vec2(uv.x * 25.0, time * 3.0));
      float emitter3 = sin(uv.x * 15.0 + time * 2.0) * 0.5 + 0.5;
      
      float combined = emitter1 * emitter2 * emitter3;
      
      if (combined > 0.25) {
        float intensity = (combined - 0.25) * 4.0 * edge;
        density += intensity * 0.08;
        temp += intensity * 0.15;
      }
    }
    
    // Velocity damping
    vel *= 0.98;
    
    // Clamp and pack output
    density = clamp(density, 0.0, 2.0);
    temp = clamp(temp, 0.0, 1.0);
    vel = clamp(vel, vec2(-2.0), vec2(2.0));
    
    O = vec4(density, temp, vel * 0.5 + 0.5);
  }
`);

sim.display(`
  void mainImage(out vec4 O, vec2 C) {
    vec2 uv = C / resolution;
    vec2 px = 1.0 / resolution;
    
    // Multi-sample for smoother appearance
    vec4 data = texture(backbuffer, uv);
    vec4 dataL = texture(backbuffer, uv - vec2(px.x, 0.0));
    vec4 dataR = texture(backbuffer, uv + vec2(px.x, 0.0));
    vec4 dataU = texture(backbuffer, uv + vec2(0.0, px.y));
    vec4 dataD = texture(backbuffer, uv - vec2(0.0, px.y));
    
    float density = data.r;
    float temp = data.g;
    
    // Smooth density for rendering
    float smoothDensity = (density + dataL.r + dataR.r + dataU.r + dataD.r) / 5.0;
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Beer-Lambert Law for Light Scattering
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    float absorption = 1.5;
    float transmittance = exp(-smoothDensity * absorption);
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Smoke Color with Temperature Influence
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    // Cool smoke is gray-blue, warm smoke has slight yellow tint
    vec3 coolSmoke = vec3(0.75, 0.78, 0.85);
    vec3 warmSmoke = vec3(0.9, 0.88, 0.82);
    vec3 smokeColor = mix(coolSmoke, warmSmoke, temp);
    
    // Darker smoke at higher densities
    vec3 denseSmoke = vec3(0.25, 0.26, 0.28);
    smokeColor = mix(smokeColor, denseSmoke, smoothDensity * 0.4);
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Lighting
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    // Compute gradient for pseudo-lighting
    float gradX = dataR.r - dataL.r;
    float gradY = dataU.r - dataD.r;
    vec3 normal = normalize(vec3(-gradX * 5.0, -gradY * 5.0, 1.0));
    
    vec3 lightDir = normalize(vec3(0.3, 0.8, 0.5));
    float diffuse = max(dot(normal, lightDir), 0.0);
    
    // Rim lighting from below
    vec3 rimDir = normalize(vec3(0.0, -1.0, 0.3));
    float rim = pow(max(dot(normal, rimDir), 0.0), 2.0);
    
    smokeColor *= 0.6 + diffuse * 0.4;
    smokeColor += vec3(0.9, 0.85, 0.7) * rim * temp * 0.3;
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Background Gradient
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    vec3 bgTop = vec3(0.02, 0.025, 0.04);
    vec3 bgBottom = vec3(0.04, 0.04, 0.05);
    vec3 bg = mix(bgBottom, bgTop, uv.y);
    
    // Subtle radial gradient
    float vignette = 1.0 - length(uv - 0.5) * 0.3;
    bg *= vignette;
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Final Compositing
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    vec3 color = mix(smokeColor, bg, transmittance);
    
    // Subtle blue atmospheric scattering
    color = mix(color, vec3(0.3, 0.4, 0.5), (1.0 - transmittance) * 0.08);
    
    // Tone mapping
    color = color / (color + 0.5);
    color = pow(color, vec3(0.95));
    
    O = vec4(color, 1.0);
  }
`);

yo(document.getElementById('c'))
  .scale(1)
  .use(sim)
  .use(fps())
  .go();

console.log('%c ğŸ’¨ mushu YO Smoke Ready ', 'background: linear-gradient(90deg, #556, #889); color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold;');
console.log('Click and drag to add smoke!');
</script>
</body>
</html>
