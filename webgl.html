<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>glsl() — One Function Creative Coding</title>
  <style>body{margin:0;overflow:hidden;background:#000}</style>
</head>
<body>
<script type="module">
// ═══════════════════════════════════════════════════════════════════════════
// glsl() — The Ultimate WebGL Creative Coding Framework
// One function. Zero boilerplate. Infinite art.
// ═══════════════════════════════════════════════════════════════════════════

const glsl = (frag) => {
  const canvas = document.createElement('canvas');
  document.body.appendChild(canvas);
  canvas.style.cssText = 'position:fixed;inset:0;width:100%;height:100%';
  const gl = canvas.getContext('webgl2');

  if (!gl) {
    alert('WebGL2 not supported');
    return;
  }

  // ─────────────────────────────────────────────────────────────────────────
  // Auto resize with devicePixelRatio
  // ─────────────────────────────────────────────────────────────────────────
  const resize = () => {
    const d = devicePixelRatio;
    canvas.width  = innerWidth  * d;
    canvas.height = innerHeight * d;
    gl.viewport(0, 0, canvas.width, canvas.height);
  };
  resize();
  addEventListener('resize', resize);

  // ─────────────────────────────────────────────────────────────────────────
  // Built-in mouse tracking (normalized -1..1)
  // ─────────────────────────────────────────────────────────────────────────
  const mouse = [0, 0];
  let mouseDown = false;
  addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    mouse[0] = (e.clientX - r.left) / r.width  * 2 - 1;
    mouse[1] = 1 - (e.clientY - r.top) / r.height * 2;
  });
  addEventListener('mousedown', () => mouseDown = true);
  addEventListener('mouseup', () => mouseDown = false);

  // ─────────────────────────────────────────────────────────────────────────
  // Fullscreen triangle VAO (no buffer needed with gl_VertexID)
  // ─────────────────────────────────────────────────────────────────────────
  const vao = gl.createVertexArray();
  gl.bindVertexArray(vao);

  // ─────────────────────────────────────────────────────────────────────────
  // Shader compiler with automatic uniforms
  // ─────────────────────────────────────────────────────────────────────────
  const compile = (f) => {
    // Vertex shader: fullscreen triangle using gl_VertexID
    const vs = `#version 300 es
      void main() {
        vec2 positions[3] = vec2[](vec2(-1,-1), vec2(3,-1), vec2(-1,3));
        gl_Position = vec4(positions[gl_VertexID], 0, 1);
      }`;

    // Fragment shader with all the built-in uniforms
    const fs = `#version 300 es
      precision highp float;
      out vec4 O;
      uniform float time;
      uniform vec2 resolution;
      uniform vec2 mouse;
      uniform float mouseDown;
      ${f}
      void main() { mainImage(O, gl_FragCoord.xy); }`;

    const p = gl.createProgram();

    const shaderTypes = [gl.VERTEX_SHADER, gl.FRAGMENT_SHADER];
    [vs, fs].forEach((src, i) => {
      const s = gl.createShader(shaderTypes[i]);
      gl.shaderSource(s, src);
      gl.compileShader(s);
      if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) {
        console.error('Shader error:', gl.getShaderInfoLog(s));
        return null;
      }
      gl.attachShader(p, s);
    });

    gl.linkProgram(p);

    if (!gl.getProgramParameter(p, gl.LINK_STATUS)) {
      console.error('Link error:', gl.getProgramInfoLog(p));
      return null;
    }

    return p;
  };

  let program = compile(frag);

  // ─────────────────────────────────────────────────────────────────────────
  // The render loop — runs forever, automatic uniforms
  // ─────────────────────────────────────────────────────────────────────────
  const loop = (t) => {
    if (!program) {
      requestAnimationFrame(loop);
      return;
    }

    gl.useProgram(program);
    gl.uniform1f(gl.getUniformLocation(program, 'time'), t * 0.001);
    gl.uniform2f(gl.getUniformLocation(program, 'resolution'), canvas.width, canvas.height);
    gl.uniform2f(gl.getUniformLocation(program, 'mouse'), mouse[0], mouse[1]);
    gl.uniform1f(gl.getUniformLocation(program, 'mouseDown'), mouseDown ? 1.0 : 0.0);
    gl.drawArrays(gl.TRIANGLES, 0, 3);
    requestAnimationFrame(loop);
  };
  requestAnimationFrame(loop);

  // ─────────────────────────────────────────────────────────────────────────
  // Hot reload — call glsl.hot(newCode) from console anytime
  // ─────────────────────────────────────────────────────────────────────────
  glsl.hot = (newFrag) => {
    const newProgram = compile(newFrag);
    if (newProgram) {
      if (program) gl.deleteProgram(program);
      program = newProgram;
      console.log('✨ Shader reloaded');
    }
  };

  return glsl;
};

// Make glsl globally available for hot reload from console
window.glsl = glsl;

// ═══════════════════════════════════════════════════════════════════════════
// DEMO: Interactive Rainbow Plasma
// Move your mouse to influence the colors!
// ═══════════════════════════════════════════════════════════════════════════

glsl(`
  // Built-in uniforms: time, resolution, mouse, mouseDown
  
  void mainImage(out vec4 fragColor, in vec2 fragCoord) {
    // Normalized coordinates (0 to 1)
    vec2 uv = fragCoord / resolution.xy;
    
    // Center-origin coordinates (-0.5 to 0.5, aspect corrected)
    vec2 p = (fragCoord - resolution.xy * 0.5) / resolution.y;
    
    // Mouse influence
    p += mouse * 0.3;
    
    // Animated plasma
    float t = time;
    
    // Multiple wave layers
    float v = 0.0;
    v += sin(p.x * 10.0 + t);
    v += sin(p.y * 10.0 + t * 0.5);
    v += sin((p.x + p.y) * 10.0 + t * 0.3);
    v += sin(length(p) * 15.0 - t * 2.0);
    v *= 0.25;
    
    // Rainbow color palette
    vec3 col = 0.5 + 0.5 * cos(t + v * 3.0 + p.xyx * 2.0 + vec3(0, 2, 4));
    
    // Add glow at mouse position when clicked
    if (mouseDown > 0.5) {
      float d = length(p - mouse * 0.3);
      col += vec3(1.0, 0.8, 0.5) * exp(-d * 5.0) * 2.0;
    }
    
    // Vignette
    col *= 1.0 - 0.3 * length(uv - 0.5);
    
    fragColor = vec4(col, 1.0);
  }
`);

console.log('%c glsl() Ready ', 'background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
console.log('Move mouse to influence shader. Click for glow effect.');
console.log('Hot reload: glsl.hot(`your new shader code`)');
</script>
</body>
</html>