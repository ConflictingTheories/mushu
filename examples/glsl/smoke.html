<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>mushu â€” glsl() Smoke Demo</title>
  <style>
    * { margin: 0; padding: 0; }
    body { background: #000; overflow: hidden; }
    .info { position: fixed; top: 10px; left: 10px; color: #fff; font: 14px monospace; 
            background: rgba(0,0,0,0.7); padding: 10px 16px; border-radius: 6px; z-index: 100; }
    .info code { color: #ff6b9d; }
    .home-link { position: fixed; bottom: 1rem; right: 1rem; background: linear-gradient(135deg, #ff6b6b, #feca57); 
                 color: #000; padding: 0.75rem 1.5rem; border-radius: 25px; text-decoration: none; 
                 font-weight: bold; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); 
                 transition: all 0.2s; z-index: 100; font-family: monospace; }
    .home-link:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }
    .home-link.hidden { display: none; }
  </style>
</head>
<body>
<div class="info">ğŸ¨ <code>mushu().glsl()</code> Smoke | Move mouse to interact</div>
<canvas id="c" style="position:fixed;inset:0;width:100%;height:100%"></canvas>
<script type="module">
import { mushu } from '../../src/index.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLSL Helper - Simple Shader-Only Volumetric Smoke
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mushu('#c').glsl(`
  float hash(vec2 p) {
    vec3 p3 = fract(vec3(p.xyx) * 0.1031);
    p3 += dot(p3, p3.yzx + 33.33);
    return fract((p3.x + p3.y) * p3.z);
  }
  
  float noise(vec2 p) {
    vec2 i = floor(p);
    vec2 f = fract(p);
    f = f * f * f * (f * (f * 6.0 - 15.0) + 10.0);
    return mix(
      mix(hash(i), hash(i + vec2(1,0)), f.x),
      mix(hash(i + vec2(0,1)), hash(i + vec2(1,1)), f.x),
      f.y
    );
  }
  
  float fbm(vec2 p, int octaves) {
    float f = 0.0;
    float amp = 0.5;
    mat2 rot = mat2(0.8, 0.6, -0.6, 0.8);
    for (int i = 0; i < 8; i++) {
      if (i >= octaves) break;
      f += amp * noise(p);
      p = rot * p * 2.0;
      amp *= 0.5;
    }
    return f;
  }
  
  void mainImage(out vec4 O, vec2 C) {
    vec2 uv = C / resolution;
    vec2 p = (C - resolution * 0.5) / resolution.y;
    float t = time * 0.4;
    
    // Base smoke columns
    float smoke = 0.0;
    
    // Multiple smoke streams
    for (int i = 0; i < 5; i++) {
      float fi = float(i);
      float xOffset = sin(fi * 1.3) * 0.3;
      vec2 smokePos = vec2(p.x - xOffset, p.y + 0.4);
      
      // Rising motion with turbulence
      float rise = fbm(vec2(smokePos.x * 2.0, t + fi), 4);
      smokePos.y += rise * 0.3;
      smokePos.x += sin(smokePos.y * 3.0 + t + fi) * 0.08;
      
      // Turbulent distortion
      float turb = fbm(smokePos * 4.0 + t * 0.5 + fi, 5);
      smokePos += (turb - 0.5) * 0.15;
      
      // Smoke density falloff
      float dist = length(smokePos * vec2(3.0, 1.0));
      float column = exp(-dist * 2.5);
      
      // Add wispy tendrils
      float tendrils = fbm(smokePos * 8.0 - vec2(0, t), 3);
      column *= (0.5 + tendrils * 0.8);
      
      smoke += column * (0.3 + 0.2 * sin(fi));
    }
    
    // Add swirling vortices
    float swirl = fbm(p * 3.0 + t * 0.3, 4);
    smoke += swirl * 0.2 * (1.0 - uv.y);
    
    // Mouse interaction - disperse smoke
    vec2 mouseP = mouse - 0.5;
    mouseP.x *= resolution.x / resolution.y;
    float mouseDist = length(p - mouseP);
    float mouseInfluence = exp(-mouseDist * 6.0);
    smoke += mouseInfluence * 0.5;
    smoke *= 1.0 - mouseInfluence * 0.4; // Dispersal effect
    
    // Volumetric lighting
    vec3 smokeColorLight = vec3(0.65, 0.68, 0.72);
    vec3 smokeColorDark = vec3(0.15, 0.15, 0.18);
    
    // Light from above
    float topLight = uv.y * 0.3;
    vec3 smokeColor = mix(smokeColorDark, smokeColorLight, topLight + smoke * 0.3);
    
    // Rim lighting
    float rim = pow(smoke, 0.5) * 0.3;
    smokeColor += vec3(0.2, 0.22, 0.25) * rim;
    
    // Beer-Lambert absorption
    float density = clamp(smoke, 0.0, 1.0);
    float transmittance = exp(-density * 2.0);
    
    // Background gradient
    vec3 bgColor = mix(vec3(0.02, 0.02, 0.04), vec3(0.08, 0.08, 0.12), uv.y);
    
    // Composite smoke over background
    vec3 color = mix(smokeColor, bgColor, transmittance);
    
    // Add subtle glow at source
    float sourceGlow = exp(-length(p + vec2(0, 0.5)) * 3.0) * 0.5;
    color += vec3(1.0, 0.6, 0.3) * sourceGlow * (1.0 - transmittance);
    
    // Film grain
    float grain = (hash(C + time) - 0.5) * 0.03;
    color += grain;
    
    // Vignette
    float vignette = 1.0 - length(uv - 0.5) * 0.4;
    color *= vignette;
    
    O = vec4(color, 1.0);
  }
`);

// FPS Counter
(function() {
  const fpsDiv = document.createElement('div');
  fpsDiv.style.cssText = 'position:fixed;bottom:10px;left:10px;color:white;font:14px monospace;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:4px;z-index:10000';
  document.body.appendChild(fpsDiv);
  let frames = 0, lastTime = performance.now();
  function updateFPS() {
    frames++;
    const now = performance.now();
    if (now - lastTime >= 500) {
      fpsDiv.textContent = Math.round(frames * 1000 / (now - lastTime)) + ' fps';
      frames = 0; lastTime = now;
    }
    requestAnimationFrame(updateFPS);
  }
  updateFPS();
})();

console.log('%c ğŸ’¨ glsl() Smoke ', 'background: linear-gradient(90deg, #ff6b9d, #ff8fab); color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold;');
console.log('Simple shader-only smoke effect using the glsl() one-liner helper');
</script>
<script>
// Hide home-link if in iframe - run immediately and on load
function hideIfIframe() {
  if (window.self !== window.top) {
    const link = document.querySelector('.home-link');
    if (link) {
      link.style.display = 'none';
    }
  }
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', hideIfIframe);
} else {
  hideIfIframe();
}
</script>
<a href="index.html" class="home-link">â† Back to Index</a>
</body>
</html>
